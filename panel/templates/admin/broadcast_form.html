{% extends "admin/base_site.html" %}
{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 700px; margin-top: 20px;">
  <div class="card shadow-sm border-0" style="background-color: #1e1e2e; color: #e6e6e6; border-radius: 0.5rem;">
    <div class="card-header bg-gradient-to-r from-blue-600 to-indigo-600 text-white" style="background: linear-gradient(90deg, #2563eb, #4f46e5); border-radius: 0.5rem 0.5rem 0 0;">
      <h2 class="h5 mb-0 d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
          <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zm-2 14l-3-3h6l-3 3z"/>
        </svg>
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É {{ user_ids|length }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
      </h2>
    </div>
    <div class="card-body">
      <!-- –í–ê–ñ–ù–û: enctype –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- –ü–æ–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ (—Å –ø—Ä–µ–≤—å—é) -->
        <div class="mb-3">
          <label for="{{ form.photo.id_for_label }}" class="form-label fw-bold">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input 
            type="file"
            id="{{ form.photo.id_for_label }}"
            name="photo"
            class="form-control"
            accept="image/jpeg,image/png,image/jpg"
            style="background-color: #2a2a3a; color: #e6e6e6; border: 1px solid #4a4a5a; padding: 0.375rem 0.75rem;"
            onchange="previewImage(event)"
          >
          {% if form.photo.errors %}
            <div class="text-danger mt-1">{{ form.photo.errors }}</div>
          {% endif %}
          <div class="form-text" style="color: #a0a0b0; font-size: 0.875em;">
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG. –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä ‚Äî 10 –ú–ë.
          </div>

          <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
          <div id="image-preview" class="mt-3" style="display: none; max-width: 100%; border: 1px solid #4a4a5a; border-radius: 0.375rem; overflow: hidden; background-color: #2a2a3a;">
            <img id="preview-img" src="" alt="–ü—Ä–µ–≤—å—é" style="max-width: 100%; height: auto; display: block;">
          </div>
        </div>

        <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="mb-3">
          <label for="{{ form.message.id_for_label }}" class="form-label fw-bold">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
          <textarea 
            id="{{ form.message.id_for_label }}"
            name="message"
            class="form-control"
            rows="6"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..."
            style="background-color: #2a2a3a; color: #e6e6e6; border: 1px solid #4a4a5a; resize: vertical;"
          >{{ form.message.value|default:"" }}</textarea>
          {% if form.message.errors %}
            <div class="text-danger mt-1">{{ form.message.errors }}</div>
          {% endif %}
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="mb-3">
          <label class="form-label fw-bold">–ö–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <button type="button" class="btn btn-sm btn-outline-primary mb-2" onclick="addButtonRow()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
          </button>
          <div id="buttons-container" class="mt-2"></div>
          <input type="hidden" name="buttons_json" id="buttons-json">
        </div>

        <!-- –°–∫—Ä—ã—Ç—ã–µ user_id -->
        {% for uid in user_ids %}
          <input type="hidden" name="user_id" value="{{ uid }}">
        {% endfor %}

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success px-4" style="background-color: #16a34a; border-color: #16a34a; color: white;">
            ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
          </button>
          <a href="{% url 'admin:panel_users_changelist' %}" class="btn btn-outline-light px-4">
            ‚Üê –ù–∞–∑–∞–¥
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- JS –¥–ª—è –ø—Ä–µ–≤—å—é -->
<script>
function previewImage(event) {
  const input = event.target;
  const preview = document.getElementById('preview-img');
  const container = document.getElementById('image-preview');

  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      container.style.display = 'block';
    };
    reader.readAsDataURL(input.files[0]);
  } else {
    container.style.display = 'none';
  }
}

let buttonCounter = 0;

function addButtonRow() {
  const container = document.getElementById('buttons-container');
  const id = buttonCounter++;
  const div = document.createElement('div');
  div.className = 'd-flex gap-2 mb-2 align-items-center';
  div.innerHTML = `
    <input type="text" 
           class="form-control form-control-sm" 
           placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" 
           onchange="updateButtonsJson()"
           data-btn-text="${id}">
    <input type="url" 
           class="form-control form-control-sm" 
           placeholder="https://example.com" 
           onchange="updateButtonsJson()"
           data-btn-url="${id}">
    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove(); updateButtonsJson();">
      üóëÔ∏è
    </button>
  `;
  container.appendChild(div);
}

function updateButtonsJson() {
  const buttons = [];
  const container = document.getElementById('buttons-container');
  const rows = container.querySelectorAll('div.d-flex');
  
  rows.forEach(row => {
    const textInput = row.querySelector('input[data-btn-text]');
    const urlInput = row.querySelector('input[data-btn-url]');
    const text = textInput.value.trim();
    const url = urlInput.value.trim();
    if (text && url) {
      buttons.push({text, url});
    }
  });
  
  document.getElementById('buttons-json').value = JSON.stringify(buttons);
}
</script>

<style>
  body {
    background-color: #121212 !important;
    color: #e6e6e6 !important;
  }
  .card {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }
  .btn-outline-light {
    color: #e6e6e6 !important;
    border-color: #e6e6e6 !important;
  }
  .btn-outline-light:hover {
    background-color: #333 !important;
    color: white !important;
  }
  .text-danger {
    color: #f87171 !important;
  }
</style>
{% endblock %}